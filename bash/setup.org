#+title: Setup Script
#+author: Henry Davies

* TABLE OF CONTENTS :toc:noexport:
- [[#script-metadata][Script Metadata]]
- [[#detect-os][Detect OS]]
  - [[#warn-user-if-script-is-run-on-an-unsupported-distrobution][Warn user if script is run on an unsupported distrobution.]]
- [[#update-system][Update System]]
- [[#third-party-repository-setup][Third Party Repository Setup]]
- [[#dependencies][Dependencies]]
  - [[#list-dependencies][List Dependencies]]
  - [[#install-dependencies][Install Dependencies]]
- [[#clone-the-required-git-repositories][Clone the required git repositories]]
  - [[#clone-the-dotfiles-repositories][Clone the dotfiles repositories]]
  - [[#clone-the-scripts-repository][Clone the scripts repository]]
- [[#create-the-required-symlinks][Create the required symlinks]]
- [[#custom-desktop-file-creation][Custom Desktop File Creation]]
- [[#launchers][Launchers]]
  - [[#launch-waybar][Launch Waybar]]
- [[#closing-message][Closing Message]]

* Script Metadata
#+begin_src bash :tangle setup.sh
#!/usr/bin/env bash

# Author: SeizeOP (HD)
# Script Name: setup.sh	
# Description: Script to setup a system with my custom dotfile and scripts.
# Github: https://SeizeOP/scripts/bash/setup.sh
# License: https://SeizeOP/scripts/LICENSE
# Contributers: SeizeOP
#+end_src

* Detect OS
#+begin_src bash :tangle setup.sh
# Detect OS from /etc/os-release
if [[ -f /etc/os-release ]]; then
    . /etc/os-release 
    DISTRO_NAME="$NAME"
    DISTRO_ID="$ID"
    echo -e "Detected OS: \e[1;32m$DISTRO_NAME\e[0m ($DISTRO_ID)"
    echo ""
else
    echo -e "Cannot detect OS version. /etc/os-release not found"
    DISTRO_NAME="unknown"
    DISTRO_ID="unknown"
fi
#+end_src

** Warn user if script is run on an unsupported distrobution.
#+begin_src bash
case $DISTRO_ID in
    unknown)
	echo -e "Cannot detect OS version. \e[1;31m/etc/os-release\e[0m not found"
	echo ""
	echo -e "This script supports ONLY distrobutions based on Fedora, Debian/Ubuntu, OpenSUSE, and Arch Linux." 
	echo "If you know that your system is based on one of these supported distrobutions you may proceed with running this script."
	echo "Otherwise, it is reccomended to exit the script now."
	echo ""
	echo "Portions of this script will work on unsupported disrobutions. However package installation and update will not work."
	echo -e "Continue to Run HD's post install script?"
	select strictreply in "Yes" "No"; do
	    case $relaxedreply in
		Yes | YES | yes | Y | y )
		    echo "Continuing to load script..."
		    echo "" ; break ;;
		No | NO | no | n )
		    echo "Exiting script..."
		    kill -9 $(ps aux | grep '[s]etup.sh' | awk '{print $2}')
	    esac
	    case $relaxedreply in
		* ) 
		    echo "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."; break ;;
    	    esac
	done
esac
#+end_src

* Update System
#+begin_src bash :tangle setup.sh
echo "It is reccomended that the system is fully up to date when running this script."
echo -e "\e[1;31mCheck for updates now?\e[0m"
select strictreply in "Yes" "No" "Quit"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    case $DISTRO_ID in
		arch|endeavoros|garuda|manjaro)
		    echo "Updating Pacman packages..."
		    sudo pacman -Syu
		    echo "" ; break ;;
		bazzite|ublue|secureblue)
		    echo -e "Updating OSTree..."
		    sudo rpm-ostree upgrade
		    echo -e "\e[1;31mPlease reboot to apply any newly downloaded OSTree\e[0m" 
		    echo "" ; break ;;
	    	debian|ubuntu|mint|zorin)
		    echo -e "Updating APT packages..."
		    sudo apt update
		    sudo apt upgrade -y 
		    echo "" ; break ;;
		fedora|redhat)
		    echo -e "Updating RPM packages..." 
		    sudo dnf upgrade --refresh -y 
		    echo "" ; break ;;
		opensuse-leap)
		    echo -e "Updating Zypper packages..."
		    sudo zypper refresh -y
		    sudo zypper update -y 
		    echo "" ; break ;;
		opensuse-tumbleweed)
		    echo -e "Updating Zypper packages..."
		    sudo zypper refresh -y
		    sudo zypper dist-upgrade -y 
		    echo "" ; break;;
	    esac
	esac
    	case $relaxedreply in
	    Quit | QUIT | quit | Q | q )
		echo "Exiting script..."
		kill -9 $(ps aux | grep '[s]etup.sh' | awk '{print $2}')
	esac
	case $relaxedreply in
	    No | NO | no | n )
		echo -e "\e[1;33mskipping system update...\e[0m" 
		echo "" ; break ;;
	    * ) 
		echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

* Third Party Repository Setup
#+begin_src bash :tangle setup.sh
echo "Some external repositories may be needed for proper installation of custom configurations." 
echo "Would you like to enable these repositories now?"
echo ""
echo -e "Selecting Yes to enabling 3rd party repositories will do \e[1;33mone\e[0m of the following:"
echo -e "\e[1;32m1.\e[0m Enable several COPRs and 3rd party repositories on Fedora" 
echo -e "\e[1;32m2.\e[0m Install an AUR helper on Arch based systems" 
echo -e "\e[1;32m3.\e[0m Enable several PPAs on Ubuntu based systems"
echo -e "\e[1;32m4.\e[0m Enable several 3rd party repositories on Bazzite/Ublue systems" 
echo ""
select strictreply in "Yes" "No" "Quit"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    case $DISTRO_ID in
		fedora|redhat)
		    # If on Fedora, enable Fedora COPRs
		    sudo dnf copr enable erikreider/SwayNotificationCenter
		    sudo dnf copr enable sdegler/hyprland
		    sudo dnf copr enable yalter/niri
		    # enable brave browser non-COPR repo for fedora
		    sudo dnf install dnf-plugins-core -y
		    sudo config-manager addrepo --from-repofile=https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo
		    echo "" ; break ;;
	    esac
	# if on Bazzite enable Brave browser repo
	    case $DISTRO_ID in
		bazzite|ublue)
		    run0 curl -fsSLo /etc/yum.repos.d/brave-browser.repo https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo
	    esac
	# If on Arch, Install an AUR helper
	    case $DISTRO_ID in
		arch|endeavoros|garuda|manjaro)		
		    sudo pacman -S --needed git base-devel && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si 		
		    echo "" ; break ;;
	    esac
	# If on Ubuntu enable Ubuntu PPAs, Universe, and Restricted repositories
	    case $DISTRO_ID in
		debian|ubuntu|mint|zorin)
		    sudo add-apt-repository universe
		    sudo add-apt-repository restricted
		    echo "" ; break ;;
	    esac
	# If on Opensuse add 3rd party repositories
	    case $DISTRO_ID in
		opensuse|opensuse-tumbleweed|opensuse-leap)
		    sudo zypper addrepo https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo
		    echo "" ; break ;;
	    esac
	esac
    case $relaxedreply in
	No | NO | no | n )  
	    echo -e "\e[1;33mSkipping 3rd party repo setup...\e[0m"
	    echo "" ; break ;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
    case $relaxedreply in
	Quit | QUIT | quit | Q | q )
	    echo "Exiting script..."
	    kill -9 $(ps aux | grep '[s]etup.sh' | awk '{print $2}')
    esac
done
#+end_src

* Dependencies
** List Dependencies
#+begin_src bash :tangle setup.sh
apt_packages=(git sway swaylock swaync waybar waypaper wlogout kitty rofi-wayland emacs tealdeer)
aur_packages=(brave-bin swaync waypaper wlogout libtool libvterm)
arch_packages=(git hyprland hyprpaper hyprlock rofi sddm sway niri waybar)
brew_cask_packages=(font-jetbrains-mono)
brew_formulae_packages=(tealdeer sqlite) 
dnf_packages=(git brave-browser emacs hyprland hyprlock hyprpaper niri ptyxis rofi-wayland sddm sway swaync waybar waypaper wlogout kitty rofi-wayland tealdeer libtool libvterm)
flatpak_packages=(com.belmoussaoui.Authenticator com.github.tchx84.Flatseal io.github.flattool.Warehouse com.nextcloud.desktopclient.nextcloud com.obsproject.Studio org.audacityteam.Audacity org.localsend.localsend_app)
suse_packages=(git hyprland hyprpaper hyprlock sddm sway niri)
ublue_packages=(git brave-browser libtool libvterm)
#+end_src

** Install Dependencies
#+begin_src bash :tangle setup.sh
echo "Woud you like to (re)install the packages required for dotfiles configurations?"
select strictreply in "Yes" "No"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    case $DISTRO_ID in
		arch|endeavoros|garuda|manjaro)
		    echo -e "\e[1;33mInstalling Pacman packages...\e[0m"
		    sudo pacman -Sy "${arch_packages[@]}"
		    if command -v yay &> /dev/null; then
			yay -Sy "${aur_packages[@]}"
		    else 
			echo "Would you like to install YAY for AUR package management?"
			echo "If you have an alternative AUR helper installed edit this script to replace YAY with it."
			select strictreply in "Yes" "No"; do
			    relaxedreply=${strictreply:-$REPLY}
			    case $relaxedreply in
				Yes | YES | yes | Y | y )
				    sudo pacman -S --needed git base-devel && git clone https://aur.archlinux.org/yay-bin.git && cd yay-bin && makepkg -si
			    esac
			    case $relaxedreply in
				No | NO | no | n )
				    echo -e "\e[1;33mSkipping YAY AUR helper installation...\e[0m"
				    echo "" ; break ;;
			    esac
			done
		    fi
	    esac
    esac
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    case $DISTRO_ID in	
		debian|ubuntu|mint|zorin)
		    sudo apt install $apt_packages -y
		    echo "" ; break ;;
		fedora|redhat)
		    sudo dnf install "${dnf_packages[@]}" -y
		    echo "" ; break ;;
		opensuse|opensuse-tumbleweed|opensuse-leap)
		    sudo zypper install "${suse_packages[@]}"
		    echo "" ; break ;;
		bazzite|ublue)
		    run0 install "${ublue_packages[@]}"
		    echo ""
		    if command -v brew &> /dev/null; then
			brew install --cask "${brew_cask_packages[@]}"
			brew install "${brew_formulae_packages[@]}"
		    else
			echo -e "\e[1;33mSkipping brew package installation...\e[0m"
		    fi
		    echo "" ; break ;;
	    esac
    esac
    case $relaxedreply in
	No | NO | no | n )  
	    echo -e "\e[1;33mSkipping installation of dependencies...\e[0m" 
	    echo "" ; break ;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
if command -v flatpak &> /dev/null; then
    echo "Would you like to install additional Flatpak packages?"
    select strictreply in "Yes" "No"; do
	relaxedreply=${strictreply:-$REPLY}
    	case $relaxedreply in
	    Yes | YES | yes | Y | y )
		flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
		flatpak install "${flatpak_packages[@]}"
		echo "" ; break ;;
	    No | NO | no | n )  
		echo -e "\e[1;33mSkipping Flatpak package installation...\e[0m"
		echo "" ; break ;;
	    * )
		echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
	esac
    done
else
    echo ""
    break
fi
#+end_src

* Clone the required git repositories
** Clone the dotfiles repositories
#+begin_src bash :tangle setup.sh
echo "Install preconfigured dotfiles?"
select strictreply in "Yes" "No" "Quit"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Quit | QUIT | quit | Q | q )
	    echo "Exiting script..."
	    kill -9 $(ps aux | grep '[s]etup.sh' | awk '{print $2}') ; break ;;
	Yes | YES | yes | Y | y ) 
	    git clone https://github.com/SeizeOP/dots.git ~/dotfiles/ 
	    echo "" ; break ;;		
	No | NO | no | n )
	    echo -e "\e[1;33mSkipping download of preconfigured dotfiles...\e[0m" 
	    echo "" ; break ;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

** Clone the scripts repository
#+begin_src bash :tangle setup.sh
echo "Woud you like to the install additional shell scripts to add system functionality?"
echo ""
echo -e "\e[1;31mNOTE:\e[0m Required for some Wlogout functionality, and launch scripts."
select strictreply in "Yes" "No" "Quit"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Quit | QUIT | quit | Q | q )
	    echo "Exiting script..."
	    kill -9 $(ps aux | grep '[s]etup.sh' | awk '{print $2}') ; break ;;
	Yes | YES | yes | Y | y ) 
	    git clone https://github.com/SeizeOP/scripts.git ~/scripts/ ; break ;;
	No | NO | no | n )
	    echo -e "Skipping download of scripts repo..." ; break ;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

* Create the required symlinks 
#+begin_src bash :tangle setup.sh
echo "Generate symlinks from ~/dotfiles/[subdir] -> ~/.config/[subdir]?" 
echo ""
echo -e "\e[1;31mNOTE:\e[0m This WILL overwrite existing files under ~/.config/[subdir]. Make backups if necessary before running."
echo -e "\e[1;31mNOTE:\e[0m Some system configurations may not function properly if not symlinked either manually or via this script."
select strictreply in "Yes" "No"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y ) 
	    ln -sf ~/dotfiles/emacs/ -t ~/.config/
	    ln -sf ~/dotfiles/hypr/ -t ~/.config/ 
	    ln -sf ~/dotfiles/niri/ -t ~/.config/ 
	    ln -sf ~/dotfiles/nwg-wrapper/ -t ~/.config/ 
	    ln -sf ~/dotfiles/rofi/ -t ~/.config/ 
	    ln -sif ~/dotfiles/sway-dracula/ -T ~/.config/sway
	    ln -sif ~/dotfiles/waybar-dracula/ -T ~/dotfiles/waybar
	    ln -sf ~/dotfiles/waybar/ -t ~/.config/
	    ln -sf ~/dotfiles/wlogout/ -t ~/.config/		
	    if [ ! -d ~/.local/bin ]; then
		echo "user bin folder [~/.local/bin] does not exist. Creating Now..."
  		mkdir -p ~/.local/bin
	    else
		echo ""
	    fi
	    ln -sf ~/scripts/bash/overrides-gui -t ~/.local/bin/
	    ln -sf ~/scripts/bash/serv-emacs -t ~/.local/bin/
	    ln -sf ~/scripts/bash/setup.sh -t ~/.local/bin/
	    if [ ! -d ~/.local/share/icons ]; then
		echo "user icons folder [~/.local/share/icons] does not exist. Creating Now..."
		mkdir -p ~/.local/share/icons
	    else
		echo ""
	    fi
	    ln -sf ~/dotfiles/images/emacs-desktop.png -t ~/.local/share/icons/
	    break ;;
	No | NO | no | n ) 
	    echo -e "\e[1;33mSkipping symlink creation...\e[0m" 
	    echo "" ; break ;;
	* ) 
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

* Custom Desktop File Creation
#+begin_src bash :tangle setup.sh
echo "Generate custom desktop files for Emacs and Overrides-gui?"
select strictreply in "Yes" "No"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    if [ ! -d ~/.local/share/applications ]; then
		echo "user applications folder [~/.local/share/applications] does not exist. Creating Now..."
  		mkdir -p ~/.local/share/applications
		echo ""
	    else
		echo ""
	    fi
	# if you use emacs --daemon replace Exec line with something like emacsclient -c -a ""
	    cat << EOF > ~/.local/share/applications/emacs.desktop
[Desktop Entry]
Categories=Development;TextEditor;
Comment=Edit text
Exec=emacs
GenericName=Text Editor
Icon=$HOME/.local/share/icons/emacs-desktop.png
MimeType=text/english;text/plain;text/x-makefile;text/x-c++hdr;text/x-c++src;text/x-chdr;text/x-csrc;text/x-java;text/x-moc;text/x-pascal;text/x-tcl;text/x-tex;application/x-shellscript;text/x-c;text/x-c++;
Name=HDmacs
StartupNotify=true
StartupWMClass=Emacs
Terminal=false
Type=Application
EOF
	    cat << EOF > ~/.local/share/applications/overrides-gui.desktop
[Desktop Entry]
Name=Overrides GUI
Comment=Simple GUI for system toggles and themeng
Exec=$HOME/.local/bin/overrides-gui
Icon=face-cool
Type=Application
Terminal=false
EOF
	break ;;
	No | NO | no | N | n )
	    echo -e "\e[1;33mSkipping Desktop File Creation...\e[0m"
	    echo "" ; break;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

* Launchers
** Launch Waybar
#+begin_src bash :tangle setup.sh
echo -e "Launch Waybar with custom configurations now?"
select strictreply in "Yes" "No"; do
    relaxedreply=${strictreply:-$REPLY}
    case $relaxedreply in
	Yes | YES | yes | Y | y )
	    if pgrep -x "Hyprland" > /dev/null; then
		waybar -c ~/dotfiles/waybar/config.jsonc -s ~/.config/waybar/style.css & disown
	    elif pgrep -x "niri" > /dev/null; then
		waybar -c ~/dotfiles/niri-waybar/config.jsonc -s ~/dotfiles/niri-waybar/style.css & disown
	    elif pgrep -x "sway" > /dev/null; then
		waybar -c ~/dotfiles/swaybar-dracula/config.jsonc -s ~/dotfiles/swaybar-dracula/style.css & disown
	    else 
		waybar & disown 
		echo "Custom Waybar configuration not loaded for $USER."
	    fi ; break;;
	No | NO | no | N | n )
	    echo -e "\e[1;33mSkipping Waybar Configuration laoding...\e[0m"
	    echo "" ; break;;
	* )
	    echo -e "Please answer \e[1;32myes\e[0m or \e[1;31mno\e[0m."
    esac
done
#+end_src

* Closing Message
#+begin_src bash :tangle setup.sh
echo "Thank you for using HD's Post install script."
echo "A reeboot may be necessary to fully apply changes made by this script."
#+end_src

* Footnotes :noexport:
#+options: num:nil toc:2 
#+startup: inlineimages fold
#+exclude_tags: noexport
#+export_file_name: ~/Documents/html/docs/setup-script.html

#+SETUPFILE: https://fniessen.github.io/org-html-themes/org/html-theme-readtheorg.setup
#+HTML_HEAD: <style>pre.src{background:#282a36;color:white;} </style>
#+HTML_HEAD: <style>code{background:#f8f8f2;color:#6272a4;} </style>
#+HTML_HEAD: <style>ul{background:#f8f8f2;} </style>

# Local Variables:
# eval: (display-line-numbers-mode -1)
# End:
